//@version=6
strategy("Drako WinPattern VWAP BullFlag", overlay=true, initial_capital=3000, default_qty_type=strategy.percent_of_equity, default_qty_value=80, commission_type=strategy.commission.percent, commission_value=0.05, slippage=2, process_orders_on_close=false, calc_on_every_tick=false, pyramiding=0)

// Preset selector
preset = input.string("Base", "Preset", options=["Base", "Best WinRate", "Best NetPnL"])

// Common inputs
minEntryPrice = input.float(1.0, "Min Entry Price ($)", minval=0.0, step=0.01)
useRTHOnly = input.bool(true, "RTH Only (ET)")
redLookback = input.int(4, "Pullback Lookback Bars", minval=2, maxval=8)

// Resolve preset parameters
stopLossPct = preset == "Best WinRate" ? 6.0 : preset == "Best NetPnL" ? 6.0 : 4.0
surgeArmPct = preset == "Best WinRate" ? 3.0 : preset == "Best NetPnL" ? 7.0 : 5.0
volMult = preset == "Best WinRate" ? 1.7 : preset == "Best NetPnL" ? 1.7 : 1.5
maxRunFromOpenPct = preset == "Best WinRate" ? 35.0 : preset == "Best NetPnL" ? 80.0 : 50.0
minRedCount = preset == "Best WinRate" ? 1 : preset == "Best NetPnL" ? 1 : 2

ema9 = ta.ema(close, 9)
vwapVal = ta.vwap(hlc3)

h = hour(time, "America/New_York")
m = minute(time, "America/New_York")
mins = h * 60 + m
inRth = mins >= 570 and mins <= 960
inEntryWindow = mins >= 571 and mins <= 630
sessionOk = (not useRTHOnly) or inRth

newDay = ta.change(time("D")) != 0
var bool supportTouched = false
var bool supportReclaimed = false
var bool tradedToday = false
var float rthOpen = na
var float rthHigh = na
var bool surgeArmed = false

if newDay
    supportTouched := false
    supportReclaimed := false
    tradedToday := false
    rthOpen := na
    rthHigh := na
    surgeArmed := false

if sessionOk
    if na(rthOpen)
        rthOpen := open
        rthHigh := high
    else
        rthHigh := math.max(rthHigh, high)

    if low < vwapVal
        supportTouched := true
    if supportTouched and close >= vwapVal
        supportReclaimed := true

runFromOpenPct = na(rthOpen) ? 0.0 : (rthHigh / rthOpen - 1.0) * 100.0
extensionOk = runFromOpenPct <= maxRunFromOpenPct

prev5Vol = nz(ta.sma(volume, 5)[1], volume)
volSurge = volume >= (volMult * prev5Vol)

redCount = 0
for i = 1 to redLookback
    redCount += close[i] < open[i] ? 1 : 0
pullbackStruct = redCount >= minRedCount

pbVolAvg = nz(ta.sma(volume, redLookback)[1], volume)
prePbVolAvg = nz(ta.sma(volume, redLookback)[redLookback + 1], volume)
pullbackLowVol = pbVolAvg < prePbVolAvg

// Enforced for all presets
pullbackOk = pullbackStruct and pullbackLowVol

signalBar = close > open and close > vwapVal and close > ema9 and volSurge and pullbackOk
priceOk = close >= minEntryPrice
entryCond = sessionOk and inEntryWindow and supportReclaimed and extensionOk and signalBar and priceOk and strategy.position_size == 0 and not tradedToday

if entryCond
    strategy.entry("L", strategy.long)
    tradedToday := true

if strategy.position_size > 0
    avgPx = strategy.position_avg_price
    stopPx = avgPx * (1.0 - stopLossPct / 100.0)
    strategy.exit("SL", "L", stop=stopPx)

    if high >= avgPx * (1.0 + surgeArmPct / 100.0)
        surgeArmed := true

    // Exits on first red close after surge arm (realistic, non-lookahead)
    if surgeArmed and close < open
        strategy.close("L", comment="FirstRedAfterSurge")

if strategy.position_size == 0
    surgeArmed := false

plot(vwapVal, "VWAP", color=color.orange, linewidth=2)
plot(ema9, "EMA9", color=color.aqua)
plotshape(entryCond, title="Entry", style=shape.triangleup, location=location.belowbar, color=color.lime, size=size.tiny)
